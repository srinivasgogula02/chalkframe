<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Valley of Focus - Botany Update</title>
    <style>
        :root { 
            --primary: #2E7D32; 
            --accent: #81C784;
            --danger: #c62828; 
            --surface: rgba(255, 255, 255, 0.95);
        }
        
        body { 
            margin: 0; overflow: hidden; background: #87CEEB;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        canvas { display: block; outline: none; }

        /* --- QUICK ACTION FAB (Bottom Center) --- */
        #fab-add {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px;
            background: var(--primary); color: white;
            border-radius: 50%; border: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            font-size: 2rem; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 95; transition: transform 0.2s, background 0.2s;
        }
        #fab-add:active { transform: translateX(-50%) scale(0.9); background: #1B5E20; }
        #fab-add span { margin-top: -4px; } /* Optical alignment */

        /* --- SIDEBAR --- */
        #sidebar {
            position: absolute; top: 0; left: 0; bottom: 0;
            width: 100%; max-width: 400px;
            background: var(--surface); backdrop-filter: blur(10px);
            box-shadow: 4px 0 30px rgba(0,0,0,0.2);
            transform: translateX(-105%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100; display: flex; flex-direction: column;
        }
        #sidebar.open { transform: translateX(0); }
        
        /* Header & Close Button */
        .sb-header { 
            padding: 20px; border-bottom: 1px solid #eee; 
            display: flex; justify-content: space-between; align-items: center;
        }
        h2 { margin: 0; font-size: 1.4rem; color: #222; }
        .close-btn {
            background: none; border: none; font-size: 2rem; color: #666;
            cursor: pointer; padding: 0 10px; line-height: 1;
        }

        /* Tabs */
        .tabs { display: flex; border-bottom: 1px solid #eee; background: rgba(0,0,0,0.02); }
        .tab { 
            flex: 1; padding: 15px 0; border: none; background: none; 
            font-weight: 600; color: #888; cursor: pointer; position: relative;
        }
        .tab.active { color: var(--primary); background: white; }
        .tab.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: var(--primary);
        }

        /* List */
        #goal-list { flex: 1; overflow-y: auto; padding: 15px; }
        
        .goal-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: border 0.2s;
        }
        .goal-item.active { border-left: 5px solid var(--primary); }
        .goal-item.dead { border-left: 5px solid var(--danger); opacity: 0.7; }
        .goal-item.completed { border-left: 5px solid gold; background: #fffde7; }

        .gi-top { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .gi-name { font-weight: bold; font-size: 1.1rem; }
        .gi-days { font-size: 0.9rem; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 10px; }
        
        .gi-actions { display: flex; gap: 10px; }
        .btn-act { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-yes { background: #E8F5E9; color: var(--primary); }
        .btn-no { background: #FFEBEE; color: var(--danger); }

        /* --- MODAL FOR NEW PLANT --- */
        #add-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        #add-modal.show { opacity: 1; pointer-events: all; }
        
        .modal-content {
            background: white; width: 85%; max-width: 320px;
            padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transform: scale(0.9); transition: transform 0.2s;
        }
        #add-modal.show .modal-content { transform: scale(1); }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .btn-plant { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { width: 100%; padding: 10px; background: none; color: #666; border: none; margin-top: 10px; }

        /* --- AUDIO TOGGLE --- */
        #sound-toggle {
            position: absolute; top: 20px; right: 20px;
            background: white; padding: 8px 12px; border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer;
            z-index: 90; font-size: 0.9rem; font-weight: 600;
        }
        
        /* --- SIDEBAR TOGGLE (Desktop) --- */
        #desktop-menu {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 10px; border-radius: 50%;
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; z-index: 90; font-size: 1.2rem;
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="desktop-menu">â˜°</div>
    
    <div id="sound-toggle">ðŸ”‡ Audio</div>

    <button id="fab-add"><span>+</span></button>

    <div id="sidebar">
        <div class="sb-header">
            <h2>Valley of Focus</h2>
            <button class="close-btn" id="close-sidebar">Ã—</button>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="App.switchTab('active')">Active</button>
            <button class="tab" onclick="App.switchTab('dead')">Graveyard</button>
            <button class="tab" onclick="App.switchTab('completed')">Eternal</button>
        </div>
        <div id="goal-list"></div>
    </div>

    <div id="add-modal">
        <div class="modal-content">
            <h3 style="margin-top:0">Plant New Goal</h3>
            <input type="text" id="m-name" placeholder="Goal Name (e.g. Reading)">
            <input type="number" id="m-days" placeholder="Days (e.g. 30)" value="30">
            <button class="btn-plant" id="btn-modal-add">Plant Tree</button>
            <button class="btn-cancel" id="btn-modal-close">Cancel</button>
        </div>
    </div>

    <script>
        // --- 1. AUDIO ENGINE (Calm) ---
        const AudioEngine = {
            ctx: null, master: null, wind: null,
            init: function() {
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain();
                this.master.gain.value = 0;
                this.master.connect(this.ctx.destination);
                
                // Wind
                const buf = this.ctx.createBuffer(1, this.ctx.sampleRate*2, this.ctx.sampleRate);
                const data = buf.getChannelData(0);
                for(let i=0; i<data.length; i++) data[i] = (Math.random()*2-1) * 0.5;
                
                const src = this.ctx.createBufferSource();
                src.buffer = buf; src.loop = true;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 300;
                const wGain = this.ctx.createGain();
                wGain.gain.value = 0.08;
                
                src.connect(filter); filter.connect(wGain); wGain.connect(this.master);
                src.start();
                this.loop();
            },
            toggle: function() {
                if(!this.ctx) this.init();
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const now = this.ctx.currentTime;
                const vol = this.master.gain.value > 0 ? 0 : 1;
                this.master.gain.setTargetAtTime(vol, now, 0.5);
                document.getElementById('sound-toggle').innerText = vol > 0 ? "ðŸ”Š Audio" : "ðŸ”‡ Audio";
            },
            loop: function() {
                if(this.master.gain.value > 0 && Math.random() > 0.995) this.chirp();
                requestAnimationFrame(() => this.loop());
            },
            chirp: function() {
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.connect(g); g.connect(this.master);
                osc.frequency.setValueAtTime(2000 + Math.random()*1000, t);
                osc.frequency.exponentialRampToValueAtTime(1000, t+0.15);
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.05, t+0.01);
                g.gain.exponentialRampToValueAtTime(0.001, t+0.15);
                osc.start(t); osc.stop(t+0.15);
            }
        };

        // --- 2. 3D SCENE & BOTANY ENGINE ---
        const Scene = {
            scene: null, camera: null, renderer: null, controls: null,
            raycaster: new THREE.Raycaster(), mouse: new THREE.Vector2(),

            init: function() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x87CEEB);
                this.scene.fog = new THREE.Fog(0x87CEEB, 20, 80);

                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
                this.camera.position.set(0, 15, 30);

                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(this.renderer.domElement);

                // Lights
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                this.scene.add(hemi);
                const sun = new THREE.DirectionalLight(0xfff5e1, 1.2);
                sun.position.set(30, 60, 30);
                sun.castShadow = true;
                sun.shadow.mapSize.width = 1024; sun.shadow.mapSize.height = 1024;
                this.scene.add(sun);

                this.createGround();
                
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.maxPolarAngle = Math.PI/2 - 0.05;

                // Tap interaction
                let downTime = 0;
                window.addEventListener('pointerdown', () => downTime = Date.now());
                window.addEventListener('pointerup', (e) => {
                    if(Date.now() - downTime < 200) this.onTap(e);
                });
                
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth/window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });

                this.animate();
            },

            createGround: function() {
                const simplex = new SimplexNoise();
                const geo = new THREE.PlaneGeometry(200, 200, 100, 100);
                const pos = geo.attributes.position;
                const colors = [];
                const c1 = new THREE.Color(0x689F38); // Base Green
                const c2 = new THREE.Color(0xDCEDC8); // Dry Green
                
                for(let i=0; i<pos.count; i++){
                    const x = pos.getX(i); const y = pos.getY(i);
                    let z = simplex.noise2D(x*0.02, y*0.02) * 2;
                    z += simplex.noise2D(x*0.05, y*0.05) * 0.5;
                    pos.setZ(i, z);
                    const mix = (z+2.5)/5;
                    const c = c1.clone().lerp(c2, mix);
                    colors.push(c.r, c.g, c.b);
                }
                geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                geo.computeVertexNormals();
                const mat = new THREE.MeshStandardMaterial({ vertexColors: true, roughness: 1 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.rotation.x = -Math.PI/2;
                mesh.receiveShadow = true;
                this.scene.add(mesh);
                this.getH = (x,z) => simplex.noise2D(x*0.02, -z*0.02)*2 + simplex.noise2D(x*0.05, -z*0.05)*0.5;
            },

            // --- REALISTIC TREE GENERATOR ---
            plantTree: function(goal) {
                const x = (Math.random()-0.5)*50;
                const z = (Math.random()-0.5)*50;
                const y = this.getH(x,z);
                
                const group = new THREE.Group();
                group.position.set(x,y,z);
                group.userData = { id: goal.id };

                // 1. Tapered Trunk
                const tGeo = new THREE.CylinderGeometry(0.1, 0.3, 1.5, 7);
                const woodMat = new THREE.MeshStandardMaterial({ color: 0x5D4037, flatShading: true });
                const trunk = new THREE.Mesh(tGeo, woodMat);
                trunk.position.y = 0.75;
                trunk.castShadow = true; 
                trunk.name = "TRUNK";
                group.add(trunk);

                // 2. Branch Structure (Invisible initially, reveals on growth)
                const canopy = new THREE.Group();
                canopy.position.y = 1.2; // Start of branches
                canopy.name = "CANOPY";
                
                // Create 4 main branches
                const branchCount = 4;
                const leafMat = new THREE.MeshStandardMaterial({ color: 0x43A047, flatShading: true });
                
                for(let i=0; i<branchCount; i++) {
                    const branchContainer = new THREE.Group();
                    branchContainer.rotation.y = (i/branchCount) * Math.PI * 2;
                    
                    // The wood branch
                    const bGeo = new THREE.CylinderGeometry(0.05, 0.1, 0.8, 4);
                    const branch = new THREE.Mesh(bGeo, woodMat);
                    branch.position.y = 0.4;
                    branch.position.z = 0.2; // Offset
                    branch.rotation.x = Math.PI / 4; // Tilt out
                    branchContainer.add(branch);

                    // The Leaf Cluster (Tuft)
                    const lGeo = new THREE.DodecahedronGeometry(0.4);
                    const leaf = new THREE.Mesh(lGeo, leafMat);
                    leaf.position.set(0, 0.8, 0.5); // End of branch
                    leaf.castShadow = true;
                    leaf.name = "LEAF"; // Mark for coloring/hiding
                    branchContainer.add(leaf);

                    canopy.add(branchContainer);
                }
                
                // Add a top tuft
                const topLeaf = new THREE.Mesh(new THREE.DodecahedronGeometry(0.5), leafMat);
                topLeaf.position.y = 0.5;
                topLeaf.castShadow = true;
                topLeaf.name = "LEAF";
                canopy.add(topLeaf);

                group.add(canopy);
                this.scene.add(group);
                
                goal.mesh = group;
                this.updateTree(goal);

                // Return position for zooming
                return group.position;
            },

            updateTree: function(goal) {
                if(!goal.mesh) return;
                const trunk = goal.mesh.getObjectByName("TRUNK");
                const canopy = goal.mesh.getObjectByName("CANOPY");

                if(goal.status === 'dead') {
                    // Dead Look
                    const deadMat = new THREE.MeshStandardMaterial({ color: 0x4E342E });
                    trunk.material = deadMat;
                    canopy.traverse(obj => {
                        if(obj.isMesh) obj.material = deadMat; // Everything brown
                        if(obj.name === "LEAF") obj.visible = false; // No leaves
                    });
                    goal.mesh.rotation.z = 0.1; // slight tilt
                } else {
                    // Growth
                    const p = Math.min(1, goal.streak / goal.totalDays);
                    const scale = 0.5 + (p * 1.5); // 0.5x to 2.0x
                    
                    trunk.scale.set(1+p, scale, 1+p);
                    canopy.position.y = (scale * 0.7) + 0.5; // Move up with trunk
                    canopy.scale.setScalar(scale);

                    // Fruiting
                    if(goal.status === 'completed') {
                        canopy.traverse(obj => {
                            if(obj.name === "LEAF") obj.material = new THREE.MeshStandardMaterial({ color: 0xFFD700 });
                        });
                    }
                }
            },

            onTap: function(e) {
                this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                this.raycaster.setFromCamera(this.mouse, this.camera);
                const hits = this.raycaster.intersectObjects(this.scene.children, true);
                for(let hit of hits) {
                    let obj = hit.object;
                    while(obj.parent && obj.parent.type !== 'Scene') {
                        if(obj.userData.id) {
                            App.openSidebarFor(obj.userData.id);
                            return;
                        }
                        obj = obj.parent;
                    }
                }
            },

            // --- CINEMATIC ZOOM ---
            zoomTo: function(pos) {
                const startPos = this.camera.position.clone();
                const startTarget = this.controls.target.clone();
                
                // Calculate nice offset view
                const endPos = pos.clone().add(new THREE.Vector3(5, 5, 5));
                const endTarget = pos.clone();

                new TWEEN.Tween(this.camera.position)
                    .to(endPos, 1500)
                    .easing(TWEEN.Easing.Cubic.Out)
                    .start();

                new TWEEN.Tween(this.controls.target)
                    .to(endTarget, 1500)
                    .easing(TWEEN.Easing.Cubic.Out)
                    .start();
            },

            animate: function(time) {
                requestAnimationFrame((t) => this.animate(t));
                TWEEN.update(time);
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        };

        // --- 3. APP CONTROLLER ---
        const App = {
            goals: [],
            activeTab: 'active',
            
            init: function() {
                Scene.init();
                
                // DOM Elements
                this.sidebar = document.getElementById('sidebar');
                this.fab = document.getElementById('fab-add');
                this.modal = document.getElementById('add-modal');
                
                // Listeners
                document.getElementById('desktop-menu').onclick = () => this.toggleSidebar(true);
                document.getElementById('close-sidebar').onclick = () => this.toggleSidebar(false);
                document.getElementById('sound-toggle').onclick = () => AudioEngine.toggle();
                
                // FAB & Modal
                this.fab.onclick = () => this.modal.classList.add('show');
                document.getElementById('btn-modal-close').onclick = () => this.modal.classList.remove('show');
                document.getElementById('btn-modal-add').onclick = () => this.createGoal();

                // Initial Data
                this.addGoalToData("Morning Jog", 30);
            },

            toggleSidebar: function(open) {
                if(open) this.sidebar.classList.add('open');
                else this.sidebar.classList.remove('open');
            },

            switchTab: function(tab) {
                this.activeTab = tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                this.renderList();
            },

            createGoal: function() {
                const name = document.getElementById('m-name').value;
                const days = parseInt(document.getElementById('m-days').value);
                if(!name) return;
                
                this.addGoalToData(name, days);
                
                // Close modal, clear inputs
                this.modal.classList.remove('show');
                document.getElementById('m-name').value = '';
            },

            addGoalToData: function(name, days) {
                const goal = {
                    id: Date.now(),
                    name: name,
                    totalDays: days,
                    streak: 0,
                    status: 'active',
                    mesh: null
                };
                this.goals.push(goal);
                
                // 1. Plant Tree
                const pos = Scene.plantTree(goal);
                
                // 2. Zoom Camera
                Scene.zoomTo(pos);

                this.renderList();
            },

            process: function(id, type) {
                const g = this.goals.find(x => x.id === id);
                if(!g) return;
                
                if(type === 'check') {
                    g.streak++;
                    if(g.streak >= g.totalDays) g.status = 'completed';
                } else {
                    g.status = 'dead';
                }
                Scene.updateTree(g);
                this.renderList();
            },

            openSidebarFor: function(id) {
                const g = this.goals.find(x => x.id === id);
                this.activeTab = g.status; // Switch to correct tab
                this.toggleSidebar(true);
                this.renderList();
                // Highlight logic could go here
            },

            renderList: function() {
                const list = document.getElementById('goal-list');
                list.innerHTML = '';
                
                const visible = this.goals.filter(g => g.status === this.activeTab);
                
                if(visible.length === 0) list.innerHTML = `<div style="text-align:center;color:#999;margin-top:20px">No goals here.</div>`;

                visible.forEach(g => {
                    const el = document.createElement('div');
                    el.className = `goal-item ${g.status}`;
                    
                    let btns = '';
                    if(g.status === 'active') {
                        btns = `
                        <div class="gi-actions">
                            <button class="btn-act btn-yes" onclick="App.process(${g.id}, 'check')">âœ“ Done</button>
                            <button class="btn-act btn-no" onclick="App.process(${g.id}, 'fail')">âœ— Missed</button>
                        </div>`;
                    }
                    
                    el.innerHTML = `
                        <div class="gi-top">
                            <span class="gi-name">${g.name}</span>
                            <span class="gi-days">${g.streak}/${g.totalDays}</span>
                        </div>
                        ${btns}
                    `;
                    el.onclick = (e) => {
                        if(e.target.tagName !== 'BUTTON') {
                            Scene.zoomTo(g.mesh.position);
                            if(window.innerWidth < 768) this.toggleSidebar(false);
                        }
                    }
                    list.appendChild(el);
                });
            }
        };

        App.init();

    </script>
</body>
</html>
